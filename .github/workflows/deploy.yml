name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: ๐ Deploy LaneGap
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ LaneGap - Production Deploy"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo ""

            # Navigate to project
            cd teczer-deployement/LaneGap
            echo "๐ Current directory: $(pwd)"
            echo ""

            # Pull latest changes
            echo "โฌ๏ธ  Pulling latest changes from main..."
            sudo git pull origin main
            echo "โ Git pull completed"
            echo ""

            # Build new images FIRST (while old containers still run)
            echo "๐จ Building Docker images (old containers still running)..."
            sudo docker compose build
            echo "โ Build completed"
            echo ""

            # Quick swap: recreate containers with new images (minimal downtime)
            echo "๐ Swapping to new containers..."
            sudo docker compose up -d --force-recreate --remove-orphans
            echo "โ Containers updated"
            echo ""

            # Clean old images AFTER new containers are running
            echo "๐งน Cleaning old Docker images..."
            sudo docker image prune -f
            echo "โ Cleanup completed"
            echo ""

            # Wait for services to be ready
            echo "โณ Waiting for services to be ready (20s)..."
            sleep 20
            echo ""

            # Health checks
            echo "๐ฅ Running health checks..."

            PB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:2123/api/health 2>/dev/null || echo "000")
            if [ "$PB_STATUS" = "200" ]; then
              echo "โ PocketBase Health: OK (HTTP 200)"
            else
              echo "โ PocketBase Health: FAILED (HTTP $PB_STATUS)"
            fi

            WEB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:2124 2>/dev/null || echo "000")
            if [ "$WEB_STATUS" = "200" ]; then
              echo "โ Web Health: OK (HTTP 200)"
            else
              echo "โ Web Health: FAILED (HTTP $WEB_STATUS)"
            fi

            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ Services Status"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            sudo docker compose ps
            echo ""

            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ Deployment Complete!"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo ""
            echo "๐ Services:"
            echo "   โข Frontend:   http://localhost:2124"
            echo "   โข PocketBase: http://localhost:2123"
            echo "   โข PB Admin:   http://localhost:2123/_/"
            echo ""
            echo "๐ Useful Commands:"
            echo "   โข View logs:    sudo docker compose logs -f"
            echo "   โข Restart:      sudo docker compose restart"
            echo "   โข Stop:         sudo docker compose down"
            echo ""
